###############################################################################
# sftpbacup_util.py
#
# by Sam Weiss
#
# Contains function that will be run in the main file
###############################################################################

import pysftp
import getpass
import os
import pdb
import json
import sys

#excluded_files = [
#how to implement this, we want to exclude some formats, but also
#maybe ignore . files and # files


max_size = 1000000 #we don't want to try and move files over 1 MB
prefs = {}


def read_prefs():
    #code will go here
    return json.loads('''something''')

def store_prefs():
    output = json.dumps

def get_target_dir_clean(dir):
    if not os.path.isdir(dir):
        log("Attempted to scan a dir that did not exist /n " + dir)
        sys.exit(1)
    currentdir = os.listdir(dir)
    for e in currentdir:
        if e[0] == '.' or e[0] == '#':
            currentdir.remove(e)
            continue
        if os.path.getsize(e) > max_size:
            currentdir.remove(e)
            continue
    return currentdir

def get_files_to_move(sftp, dir):
    target = get_target_dir_clean(dir)
    remote_files = sftp.listdir_attr()
    remote_modified = {}
    for e in remote_files:
        name = e.filename
        if name[0] != '.' and name[0] != '#':
            remote_modified[name] = e.st_mtime
    for e in target:
        if sftp.isfile(e):
            local_mod = os.stat(e).st_mtime
            remote_mod = remote_modified[e]
            if local_mod <= remote_mod:
                target.remove(e)

def log(string):
    print "--------------------------------------"
    print string
    print "--------------------------------------"
